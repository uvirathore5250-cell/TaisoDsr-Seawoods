<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TAISO - OFFICIAL DSR</title>
    <style>
        :root { --neon: #92d050; --bg: #000; --card: #111; }
        body { background: var(--bg); color: #fff; font-family: sans-serif; padding: 0; margin: 0; padding-bottom: 85px; }
        
        /* Header */
        .header { position: fixed; top: 0; width: 100%; background: #1a1a1a; padding: 15px 0; text-align: center; border-bottom: 2px solid var(--neon); z-index: 1000; font-weight: bold; font-size: 18px; }
        
        /* Navigation */
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: #1a1a1a; display: flex; border-top: 1px solid #333; z-index: 1000; }
        .nav-item { flex: 1; padding: 15px; text-align: center; color: #666; font-weight: bold; cursor: pointer; }
        .nav-item.active { color: var(--neon); border-top: 3px solid var(--neon); background: #222; }

        /* Pages */
        .content-page { display: none; padding: 85px 15px 20px 15px; }
        .content-page.active { display: block; }

        /* Card Design (Same as CRM) */
        .dsr-card { background: var(--card); padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 1px solid #222; border-left: 5px solid var(--neon); }
        .history-box { font-size: 11px; background: #000; padding: 10px; border-radius: 8px; margin: 10px 0; color: #ccc; border: 1px dashed #444; white-space: pre-line; }
        
        /* Inputs & Buttons */
        input, textarea, .save-btn { width: 100%; padding: 14px; margin: 8px 0; background: #050505; border: 1px solid #333; color: #fff; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
        .save-btn { background: var(--neon); color: #000; font-weight: bold; border: none; cursor: pointer; margin-top: 10px; }
        
        .update-btn { width: 100%; padding: 12px; border-radius: 8px; font-weight: bold; border: 1px solid var(--neon); background: transparent; color: var(--neon); cursor: pointer; }
        .update-form { background: #1a1a1a; padding: 15px; border-radius: 12px; margin-top: 10px; display: none; border: 1px solid #333; }
        
        label { font-size: 11px; color: var(--neon); margin-left: 5px; text-transform: uppercase; font-weight: bold; }
        .row { display: flex; gap: 10px; }
        .row div { flex: 1; }
    </style>
</head>
<body>

    <div class="header">TAISO DSR SYSTEM</div>

    <div id="page-add" class="content-page active">
        <div style="background:var(--card); padding:20px; border-radius:20px; border: 1px solid #222;">
            <label>Report Date</label>
            <input type="date" id="rDate">

            <div class="row">
                <div><label>Gym Cash</label><input type="number" id="gCash" value="0"></div>
                <div><label>Gym UPI</label><input type="number" id="gUpi" value="0"></div>
            </div>

            <div class="row">
                <div><label>PT Cash</label><input type="number" id="pCash" value="0"></div>
                <div><label>PT UPI</label><input type="number" id="pUpi" value="0"></div>
            </div>

            <label>Enquiries Today</label>
            <input type="number" id="enq" value="0">

            <label>Summary Notes</label>
            <textarea id="note" rows="3" placeholder="Enter today's details..."></textarea>
            
            <button onclick="submitDSR()" id="mainBtn" class="save-btn">SAVE DSR REPORT</button>
        </div>
    </div>

    <div id="page-history" class="content-page">
        <div id="listContainer"></div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="nav('add', this)">âž• NEW ENTRY</div>
        <div class="nav-item" onclick="nav('history', this)">ðŸ“œ OLD HISTORY</div>
    </div>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbwXGHsO9GNyIXFflTXTVnfbGtJfCyD1pEO17AiK1egbyiDIejYgi7GQ6Jyfd-KcvPcSpA/exec'; 
        let reports = [];

        document.getElementById('rDate').valueAsDate = new Date();

        function nav(p, el) {
            document.querySelectorAll('.content-page').forEach(pg => pg.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(nv => nv.classList.remove('active'));
            document.getElementById('page-' + p).classList.add('active');
            el.classList.add('active');
            if(p === 'history') sync();
        }

        async function sync() {
            const container = document.getElementById('listContainer');
            container.innerHTML = "<p style='text-align:center; color:#666;'>Loading History...</p>";
            try {
                const res = await fetch(scriptURL + '?t=' + Date.now());
                reports = await res.json();
                render();
            } catch(e) { container.innerHTML = "Error loading data."; }
        }

        async function submitDSR() {
            const btn = document.getElementById('mainBtn');
            btn.innerText = "Saving...";
            btn.disabled = true;
            
            const gC = document.getElementById('gCash').value, gU = document.getElementById('gUpi').value;
            const pC = document.getElementById('pCash').value, pU = document.getElementById('pUpi').value;
            const date = document.getElementById('rDate').value;
            const note = document.getElementById('note').value;

            // CRM Style History Logic
            const historyEntry = `[${new Date().toLocaleDateString()}] Initial: ${note}\nGym Total: â‚¹${Number(gC)+Number(gU)} | PT Total: â‚¹${Number(pC)+Number(pU)}\nEnq: ${document.getElementById('enq').value}`;

            const payload = {
                date: date, gymCash: gC, gymUpi: gU, ptCash: pC, ptUpi: pU, enq: document.getElementById('enq').value,
                history: historyEntry
            };

            await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            alert("Report Saved!");
            location.reload();
        }

        function render() {
            const cont = document.getElementById('listContainer');
            cont.innerHTML = '';
            if(reports.length === 0) {
                cont.innerHTML = "<p style='text-align:center; color:#666;'>No records found.</p>";
                return;
            }

            [...reports].reverse().forEach((r, idx) => {
                const realIdx = reports.indexOf(r);
                const div = document.createElement('div');
                div.className = 'dsr-card';
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <b style="color:var(--neon)">${r.date.split('T')[0]}</b>
                        <span style="font-size:12px; background:#222; padding:3px 8px; border-radius:5px;">â‚¹${Number(r.gymCash||0)+Number(r.gymUpi||0)+Number(r.ptCash||0)+Number(r.ptUpi||0)}</span>
                    </div>
                    <div class="history-box">${r.history || 'No details'}</div>
                    <button class="update-btn" onclick="document.getElementById('f-${realIdx}').style.display='block'">âž• UPDATE NOTES</button>
                    <div id="f-${realIdx}" class="update-form">
                        <textarea id="m-${realIdx}" placeholder="Add more updates..."></textarea>
                        <button onclick="updateReport(${realIdx})" class="save-btn">SAVE UPDATE</button>
                    </div>
                `;
                cont.appendChild(div);
            });
        }

        async function updateReport(idx) {
            const msg = document.getElementById(`m-${idx}`).value;
            if(!msg) return alert("Enter something!");
            const newHistory = reports[idx].history + `\n| [${new Date().toLocaleDateString()}] Update: ${msg}`;
            const payload = { ...reports[idx], history: newHistory };
            
            await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            sync();
        }
    </script>
</body>
</html>
